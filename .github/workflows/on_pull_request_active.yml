name: "PR: Build, test and deploy preview"

on:
  pull_request:

env:
  PREVIEW_NAME: pr-${{ github.event.number }}
  ACCOUNT_ID: 0dd44352714dc8c855d81b72164cd961
  MAINNET_PROJECT: deployment-testing-mainnet
  MAINNET_PRODUCTION_URL: deployment-testing.pages.dev
  TESTNET_PROJECT: deployment-testing-testnet
  TESTNET_PRODUCTION_URL: deployment-testing-testnet.pages.dev

jobs:
  checkout:
    name: "Checkout"
    runs-on: ubuntu-latest
    steps:
      - name: "Test var ${{ env.ACCOUNT_ID }}"
        run: "echo $ACCOUNT_ID"
      - uses: actions/checkout@v3
  mainnet-build:
    name: "Mainnet"
    needs:
      - checkout
    uses: ./.github/workflows/build_job.yml
    with:
      network: mainnet
      test: true
      account_id: "${{ env.ACCOUNT_ID }}"
      branch: "${{ env.PREVIEW_NAME }}"
      project: "${{ env.MAINNET_PROJECT }}"
    secrets: inherit
  testnet-build:
    name: "Testnet"
    needs:
      - checkout
    uses: ./.github/workflows/build_job.yml
    with:
      network: testnet
      test: true
      account_id: "${{ env.ACCOUNT_ID }}"
      branch: "${{ env.PREVIEW_NAME }}"
      project: "${{ env.TESTNET_PROJECT }}"
    secrets: inherit
  comment:
    name: "Comment Pull Request"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    needs:
      - mainnet-build
      - testnet-build
    steps:
      - name: Comment
        uses: edumserrano/find-create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.number }}
          body-includes: '<!-- pr-ci-comment -->'
          comment-author: 'github-actions[bot]'
          body: | # can be a single value or you can compose text with multi-line values
            <!-- pr-ci-comment -->
            # Deploy Preview Details

            | **Built from SHA:**     | `${{ GITHUB_SHA }}` |
            | **Mainnet URL**:        | ${{ env.PREVIEW_NAME }}.${{ env.MAINNET_PRODUCTION_URL }} |
            | **Testnet URL**:        | ${{ env.PREVIEW_NAME }}.${{ env.TESTNET_PRODUCTION_URL }} |
          edit-mode: replace
