name: "PR: Build, test and deploy preview"
on:
  pull_request:
jobs:
  checkout:
    name: "Checkout"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
  mainnet-build:
    name: "Mainnet"
    needs:
      - checkout
    uses: ./.github/workflows/build_job.yml
    with:
      network: mainnet
      test: true
  mainnet-publish:
    name: "Mainnet"
    needs:
      - mainnet-build
    runs-on: ubuntu-latest
    steps:
      - name: publish
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: 0dd44352714dc8c855d81b72164cd961
          projectName: deployment-testing-mainnet
          directory: dist/spa
          # Optional: Enable this if you want to have GitHub Deployments triggered
          # gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          # the branch is used for the URL, it does not need to equal the current branch so we can
          #    use it to set the name in the deployment URL
          branch: pr-${{ github.event.number }}
  testnet-build:
    name: "Testnet"
    needs:
      - checkout
    uses: ./.github/workflows/build_job.yml
    with:
      network: testnet
      test: true
  testnet-publish:
    name: "Testnet"
    needs:
      - testnet-build
    runs-on: ubuntu-latest
    steps:
    - name: publish
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: 0dd44352714dc8c855d81b72164cd961
        projectName: deployment-testing-testnet
        directory: dist/spa
        # Optional: Enable this if you want to have GitHub Deployments triggered
        # gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        # the branch is used for the URL, it does not need to equal the current branch so we can
        #    use it to set the name in the deployment URL
        branch: pr-${{ github.event.number }}
